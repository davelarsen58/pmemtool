# Example Script generated by pmemtool

[PMemtool](README.md) provides an option to generate scripts to enable administrators to recover from a hardware failure
by rebuilding the persistent memory region, namespace, and updating the /etc/fstab for the filesystem.

It is highly recommended to periodically regenerate the recovery scripts to capture changes in physical
or logical configurations.

Recovery scripts are generated for each socket configured for App Direct with entries in teh /etc/fstab.

## The following script was generated by pmt using the --recovery option.

```bash
#!/bin/bash
#
# Script created: 2022-02-07 16:56:16.346897
# Created on system: wfp01
# PMT script version: 1.00.0
# Recoverying:
#   Socket: 0x0000
#   Region: region0
#   Dimms: 0x0001,0x0011,0x0021,0x0101,0x0111,0x0121

# --- Clean Up Old Provisioning ---
# Remove demand against PMEM, so we can reconfigure

# NOTE: Recovering from a failed DIMM, these commands
#       may fail due to filesystem not being mounted,
#       namespaces being re-enumerated due to nmem changes,
#       and regions being hidden due to failed interleave-set
#       nmem devices, namespace devices, and regions are all
#       dynamically enumerated at boot time based upon hardware
#       availability

logger Beginning Recovery of PMEM on socket 0x0000

if [ ! `mountpoint -q /pmemfs0` ]; then
         echo "Unmounting /pmemfs0"
         logger unmounting /pmemfs0
         umount /pmemfs0
else
        echo "/pmemfs0 is not mounted"

fi

# Note: These two commands will fail if re-enumeration has happened
ndctl disable-namespace namespace0.0
ndctl disable-region region0

# --- Erasing PMEM Devices used by this region ---
# Note: On completion, ipmctl will respond that all DIMMs have been cleared.
#       There is no cause for concern
logger deleting PMEM configuration for socket 0x0000 for dimms 0x0001,0x0011,0x0021,0x0101,0x0111,0x0121
echo deleting PMEM configuration for socket 0x0000 for dimms 0x0001,0x0011,0x0021,0x0101,0x0111,0x0121
ipmctl delete -f -dimm -pcd 0x0001,0x0011,0x0021,0x0101,0x0111,0x0121

# Create new PMEM Region for this socket
logger creating new PMEM configuration for socket 0x0000
echo creating new PMEM configuration for socket 0x0000
ipmctl create -goal -socket 0x0000

# Reboot at this point to create the pmem region
# unless there are more regions to be created now

while [ true ] ; do
         read -p "Do you wish to reboot now?" yn
         case $yn in
                 [Yy]* ) echo Rebooting Now; shutdown -r now; break;;
                 [Nn]* ) reboot later after all changes are made;;
                 * ) echo "Please answer yes or no.";;
         esac
done

# --- Post Boot provisioning ---

# no_namespace will contain 0, if there are no namespaces in this region.
namespaces_exist=`ndctl list -N -r region0 | wc -l`
if [ "namespace_exist" -ne 0 ] ; then
         echo Namespace Exists on region: region0
         echo You Cannot Create a new namespace if there is no room on region0
         exit 1
fi
echo Creating namespace on region: region0
ndctl create-namespace --mode fsdax --region region0
# --- Create PMFS on pmem device ---
echo Creating filesystem on region0:namespace0.0->/dev/pmem0
mkfs -t xfs -m reflink=0 -f /dev/pmem0
# --- Create PMFS Mount Point ---
echo Checking mount point
if [ ! -d /pmemfs0 ] ; then
         echo creating /pmemfs0
         mkdir /pmemfs0
else
         echo Mount point exists!
fi
echo --- Create updated fstab entry for /pmemfs0---

echo --- Get the PMFS UUID ---
new_uuid=`blkid /dev/pmem0`
echo $new_uuid
echo --- extracting fstab entry for mount point /pmemfs0 ---

rest=`grep /etc/fstab | cut -f2- /pmemfs0`
echo --- merging new uuid $new_uuid with original $rest %s ---
new_entry=`echo $new_uuid $rest`

# --- Use below line to update /etc/fstab.
echo $new_entry
# --- Use above line to update /etc/fstab.

# --- End of Script ---
```
